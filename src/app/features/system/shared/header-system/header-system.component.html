<header>
    <div class="container_header">
        <div class="container_logo">
            <img src="img/logo/logo_verde.png" alt="Logo">
        </div>
        <div class="container_links">
            <div class="botao_mensagem">
                <button class="botao" (click)="toggleChat()">
                    <div class="container_icone">
                        <img src="" alt="">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 25" width="20" height="20"
                            fill="rgba(62,153,114,1)">
                            <path
                                d="M2 8.99374C2 5.68349 4.67654 3 8.00066 3H15.9993C19.3134 3 22 5.69478 22 8.99374V21H8.00066C4.68659 21 2 18.3052 2 15.0063V8.99374ZM20 19V8.99374C20 6.79539 18.2049 5 15.9993 5H8.00066C5.78458 5 4 6.78458 4 8.99374V15.0063C4 17.2046 5.79512 19 8.00066 19H20ZM14 11H16V13H14V11ZM8 11H10V13H8V11Z">
                            </path>
                        </svg>
                    </div>
                    Mensagens
                </button>
            </div>

            <div class="container_usuario" [class.clickable]="isGestor" (click)="abrirModalPerfil()"
                style="cursor: pointer; position: relative; z-index: 50;">
                <div class="usuario_dados">
                    <h5>
                        {{ usuarioNome }}
                    </h5>
                    <p>
                        {{ usuarioEmail }}
                    </p>
                    <span class="usuario-cargo">
                        {{ usuarioCargo }}
                    </span>
                </div>
                <div class="usuario_foto">
                    <!-- Placeholder de imagem ou avatar -->
                </div>
            </div>
            <div class="container_button">
                <button (click)="logout()" class="botao">
                    <div class="container_icone">
                        <img src="" alt="">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 23 25" width="20" height="20"
                            fill="rgba(62,153,114,1)">
                            <path
                                d="M4 18H6V20H18V4H6V6H4V3C4 2.44772 4.44772 2 5 2H19C19.5523 2 20 2.44772 20 3V21C20 21.5523 19.5523 22 19 22H5C4.44772 22 4 21.5523 4 21V18ZM6 11H13V13H6V16L1 12L6 8V11Z">
                            </path>
                        </svg>
                    </div>
                    Logout
                </button>
            </div>
        </div>
    </div>
</header>

<!-- Chat Modal -->
<div class="chat-overlay" *ngIf="chatAberto" (click)="toggleChat()"></div>
<div class="chat-container" *ngIf="chatAberto">
    <div class="chat-header">
        <div class="chat-header-content">
            <button class="btn-voltar" *ngIf="usuarioSelecionado" (click)="voltarListaUsuarios()">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="20" height="20" fill="currentColor">
                    <path d="M7.828 11H20v2H7.828l5.364 5.364-1.414 1.414L4 12l7.778-7.778 1.414 1.414z"></path>
                </svg>
            </button>
            <h3 *ngIf="!usuarioSelecionado">Mensagens</h3>
            <h3 *ngIf="usuarioSelecionado">{{usuarioSelecionado.userName}} {{usuarioSelecionado.sobrenome}}</h3>
        </div>
        <button class="chat-close" (click)="toggleChat()">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="24" height="24" fill="currentColor">
                <path
                    d="M12 10.586l4.95-4.95 1.414 1.414-4.95 4.95 4.95 4.95-1.414 1.414-4.95-4.95-4.95 4.95-1.414-1.414 4.95-4.95-4.95-4.95L7.05 5.636z">
                </path>
            </svg>
        </button>
    </div>

    <!-- Tabs -->
    <div class="chat-tabs" *ngIf="!usuarioSelecionado">
        <button class="tab-btn" [class.active]="abaAtiva === 'geral'" (click)="mudarAba('geral')">
            Geral
        </button>
        <button class="tab-btn" [class.active]="abaAtiva === 'diretas'" (click)="mudarAba('diretas')">
            Diretas
        </button>
    </div>

    <!-- Lista de usuários (apenas na aba Diretas) -->
    <div class="paciente-selecao" *ngIf="abaAtiva === 'diretas' && !usuarioSelecionado">
        <label for="paciente-select">Selecione um Paciente:</label>
        <select id="paciente-select" class="paciente-dropdown" (change)="selecionarPaciente($event)">
            <option value="">-- Escolha um paciente --</option>
            <option *ngFor="let paciente of pacientes" [value]="paciente.nomePaciente">
                {{paciente.nomePaciente}}
            </option>
        </select>
    </div>

    <div class="usuarios-lista" *ngIf="abaAtiva === 'diretas' && !usuarioSelecionado && pacienteSelecionado">
        <div class="usuario-item" *ngFor="let usuario of usuariosFiltrados" (click)="selecionarUsuario(usuario)">
            <div class="usuario-avatar">
                {{usuario.userName.charAt(0).toUpperCase()}}
            </div>
            <div class="usuario-info">
                <div class="usuario-nome">{{usuario.userName}} {{usuario.sobrenome}}</div>
                <div class="usuario-role">{{usuario.role}}</div>
            </div>
            <div class="badge-nao-lidas" *ngIf="getNumeroMensagensNaoLidas(usuario.userName) > 0">
                {{getNumeroMensagensNaoLidas(usuario.userName)}}
            </div>
        </div>
    </div>

    <!-- Mensagens -->
    <div class="chat-messages" *ngIf="abaAtiva === 'geral' || usuarioSelecionado">
        <div class="mensagem-vazia" *ngIf="getMensagensAtivas().length === 0">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="48" height="48"
                fill="rgba(156,163,175,1)">
                <path
                    d="M6.455 19L2 22.5V4C2 3.44772 2.44772 3 3 3H21C21.5523 3 22 3.44772 22 4V18C22 18.5523 21.5523 19 21 19H6.455ZM4 18.385L5.763 17H20V5H4V18.385Z">
                </path>
            </svg>
            <p>Nenhuma mensagem ainda</p>
        </div>

        <div class="mensagem" *ngFor="let msg of getMensagensAtivas()">
            <div class="mensagem-conteudo">
                <div class="mensagem-header">
                    <span class="mensagem-autor">{{msg.autor}}</span>
                    <span class="mensagem-hora">{{msg.hora}}</span>
                </div>
                <p class="mensagem-texto">{{msg.texto}}</p>
            </div>
        </div>
    </div>

    <!-- Input (apenas quando não está na lista de usuários) -->
    <div class="chat-input" *ngIf="podeEnviarMensagem">
        <textarea [(ngModel)]="mensagemTexto" (keydown)="onKeyDown($event)"
            placeholder="Digite sua mensagem... (Ctrl+Enter para enviar)" class="input-mensagem" rows="1"></textarea>
        <button (click)="enviarMensagem()" class="btn-enviar">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="20" height="20" fill="currentColor">
                <path
                    d="M3 13.0001H9V11.0001H3V1.84558C3 1.56944 3.22386 1.34558 3.5 1.34558C3.58425 1.34558 3.66714 1.36687 3.74096 1.40747L22.2034 11.5618C22.4454 11.6949 22.5337 11.9989 22.4006 12.2409C22.3549 12.324 22.2865 12.3924 22.2034 12.4381L3.74096 22.5924C3.499 22.7255 3.19497 22.6372 3.06189 22.3953C3.02129 22.3214 3 22.2386 3 22.1543V13.0001Z">
                </path>
            </svg>
        </button>
    </div>

    <!-- Mensagem de Somente Leitura -->
    <div class="chat-read-only" *ngIf="abaAtiva === 'geral' && !podeEnviarMensagem">
        <p>Apenas visualização.</p>
    </div>
</div>

<!-- Modal Container Unificado -->
<div class="modal-overlay" *ngIf="estadoModal !== 'fechado'" (click)="fecharModal()">

    <!-- Conteúdo: Editar Perfil -->
    <div class="modal-perfil" *ngIf="estadoModal === 'perfil'" (click)="$event.stopPropagation()">
        <div class="modal-perfil-header">
            <h3>Editar Perfil</h3>
            <button class="btn-close" (click)="fecharModal()">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="24" height="24" fill="currentColor">
                    <path
                        d="M11.9997 10.5865L16.9495 5.63672L18.3637 7.05093L13.4139 12.0007L18.3637 16.9504L16.9495 18.3646L11.9997 13.4149L7.04996 18.3646L5.63574 16.9504L10.5855 12.0007L5.63574 7.05093L7.04996 5.63672L11.9997 10.5865Z">
                    </path>
                </svg>
            </button>
        </div>

        <div class="modal-perfil-body">
            <div class="perfil-form-group">
                <label>Nome</label>
                <input type="text" [(ngModel)]="perfilEditando.nome" class="perfil-input">
            </div>

            <div class="perfil-form-group">
                <label>Email</label>
                <input type="email" [(ngModel)]="perfilEditando.email" class="perfil-input">
            </div>

            <div class="perfil-form-group">
                <label>Telefone</label>
                <input type="tel" [(ngModel)]="perfilEditando.telefone" class="perfil-input"
                    placeholder="(00) 00000-0000">
            </div>

            <div class="perfil-form-group">
                <label>Senha</label>
                <input type="password" [(ngModel)]="perfilEditando.senha" class="perfil-input"
                    placeholder="Nova senha (opcional)">
            </div>
        </div>

        <div class="modal-perfil-footer">
            <button class="btn-cancelar" (click)="fecharModal()">Cancelar</button>
            <button class="btn-salvar" (click)="$event.stopPropagation(); salvarPerfil()">Salvar</button>
        </div>
    </div>

    <!-- Conteúdo: Sucesso -->
    <div class="modal-sucesso" *ngIf="estadoModal === 'sucesso'" (click)="$event.stopPropagation()">
        <div class="icone-sucesso">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="48" height="48" fill="#34d399">
                <path
                    d="M12 22C6.47715 22 2 17.5228 2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22ZM11.0026 16L18.0737 8.92893L16.6595 7.51472L11.0026 13.1716L8.17421 10.3431L6.75999 11.7574L11.0026 16Z">
                </path>
            </svg>
        </div>
        <h3>Sucesso!</h3>
        <p>Seu perfil foi atualizado com sucesso.</p>
        <button class="btn-ok" (click)="fecharModal()">OK</button>
    </div>

</div>